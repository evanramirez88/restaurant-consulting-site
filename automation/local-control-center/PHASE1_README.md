# Phase 1: Core Infrastructure - "The Digital Floor"

## Overview

This directory contains the Docker-based infrastructure for the R&G Consulting Autonomous Architect system, running on the Lenovo m720q homelab (SAGE-LENOVO).

## Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DOCKER COMPOSE: rg-digital-floor                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌────────────────┐  ┌───────────────────────┐  │
│  │  nginx   │  │   n8n    │  │ browser-service│  │ postgres (pgvector)   │  │
│  │  :80/443 │  │  :5678   │  │     :3000      │  │       :5432           │  │
│  └──────────┘  └──────────┘  └────────────────┘  └───────────────────────┘  │
│                                                                              │
│  ┌──────────┐  ┌──────────┐  ┌────────────────┐  ┌───────────────────────┐  │
│  │  redis   │  │  minio   │  │      api       │  │       backup          │  │
│  │  :6379   │  │:9000/9001│  │     :8000      │  │     (cron)            │  │
│  └──────────┘  └──────────┘  └────────────────┘  └───────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Services

| Service | Port | Purpose |
|---------|------|---------|
| **nginx** | 80, 443 | Reverse proxy, SSL termination, webhook routing |
| **n8n** | 5678 | Workflow orchestration, HubSpot/Trello/Twilio integration |
| **browser-service** | 3000 | Playwright automation API for Toast ABO |
| **postgres** | 5432 | PostgreSQL 16 with pgvector for Intelligence Engine |
| **redis** | 6379 | Caching, sessions, pub/sub messaging |
| **minio** | 9000, 9001 | S3-compatible object storage |
| **api** | 8000 | FastAPI control center (clients, projects, sync) |
| **backup** | - | Daily PostgreSQL backups |

## Quick Start

### Prerequisites

1. **Docker Desktop** installed and running
2. **Seagate 20TB drive** mounted (default: S:)
3. **Windows Terminal** or PowerShell 7+

### First-Time Setup

```powershell
# Navigate to local-control-center
cd automation/local-control-center

# Run startup script (creates .env, directories, starts containers)
.\start-phase1.ps1 -SeagateDriveLetter "S" -Build
```

### Daily Operations

```powershell
# Start all services
.\start-phase1.ps1

# Stop all services
.\stop-phase1.ps1

# View logs
docker compose -f docker-compose.phase1.yml logs -f

# View specific service logs
docker compose -f docker-compose.phase1.yml logs -f n8n
```

## Access Points

### Local Access

| Service | URL |
|---------|-----|
| Dashboard | http://localhost/ |
| n8n Workflows | http://localhost:5678/ |
| Browser Service | http://localhost:3000/health |
| Control API | http://localhost:8000/docs |
| MinIO Console | http://localhost:9001/ |

### Tailscale Access

| Service | URL |
|---------|-----|
| n8n | http://sage-lenovo.tail0fa33b.ts.net:5678 |
| API | http://100.72.223.35:8000 |

### Webhook Endpoints

| Source | URL |
|--------|-----|
| HubSpot | http://localhost/webhook/hubspot/* |
| Trello | http://localhost/webhook/trello/* |
| Cloudflare | http://localhost/webhook/cloudflare/* |
| Custom | http://localhost/webhook/* |

## Configuration

### Environment Variables

Copy `.env.phase1.example` to `.env` and configure:

```bash
# Required
SEAGATE_MOUNT=S:              # Your Seagate drive letter
POSTGRES_PASSWORD=xxx         # Generated by startup script
REDIS_PASSWORD=xxx            # Generated by startup script
N8N_PASSWORD=xxx              # Generated by startup script

# Optional (for full functionality)
CLOUDFLARE_API_TOKEN=xxx      # For D1 sync
HUBSPOT_ACCESS_TOKEN=xxx      # For CRM integration
ANTHROPIC_API_KEY=xxx         # For AI features
SLACK_ALERT_WEBHOOK=xxx       # For notifications
```

### Data Storage

All persistent data is stored on the Seagate drive:

```
S:\rg_data\
├── postgres/       # PostgreSQL data
├── redis/          # Redis persistence
├── minio/          # Object storage
├── backups/        # Daily SQL backups
├── clients/        # Client file storage
├── sync/           # Cloudflare sync queue
└── n8n/            # n8n configuration
```

## Browser Service API

The browser-service provides a REST API for Playwright automation:

```bash
# Health check
curl http://localhost:3000/health

# Create session
curl -X POST http://localhost:3000/session/create \
  -H "Content-Type: application/json" \
  -d '{"clientId": "test"}'

# Navigate
curl -X POST http://localhost:3000/session/{id}/navigate \
  -H "Content-Type: application/json" \
  -d '{"url": "https://pos.toasttab.com"}'

# Take screenshot
curl -X POST http://localhost:3000/session/{id}/screenshot \
  -H "Content-Type: application/json" \
  -d '{"fullPage": true}'
```

## n8n Workflows

Pre-built workflow templates are in `n8n-workflows/`:

- Menu Intake Pipeline (Email → OCR → Toast)
- Lead Validation (D1 → Score → Segment)
- Billing Automation (Trello → Square)
- Daily Briefing (DATA_CONTEXT → Summary)

Import workflows via n8n UI: Settings → Import from File

## Database

### Intelligence Engine Tables

| Table | Purpose |
|-------|---------|
| `facts` | Extracted facts with pgvector embeddings |
| `workflow_runs` | n8n execution history |
| `browser_sessions` | Automation session logs |
| `health_check_results` | Toast selector validation |
| `automation_failure_states` | Pause/resume state |

### Connect to PostgreSQL

```bash
# Via Docker
docker exec -it rg-postgres psql -U rg_admin -d rg_consulting

# Via local client
psql -h localhost -U rg_admin -d rg_consulting
```

## Troubleshooting

### Container won't start

```powershell
# Check logs
docker compose -f docker-compose.phase1.yml logs <service>

# Rebuild container
docker compose -f docker-compose.phase1.yml build <service>
```

### PostgreSQL connection refused

```powershell
# Check if container is healthy
docker inspect rg-postgres --format='{{.State.Health.Status}}'

# Check logs
docker logs rg-postgres
```

### n8n webhook not receiving

1. Check nginx is running: `docker logs rg-nginx`
2. Verify URL in webhook service matches `/webhook/*` pattern
3. For external webhooks, ensure Cloudflare Tunnel or ngrok is configured

### Browser service out of memory

Reduce concurrent sessions in `.env`:
```
MAX_BROWSER_SESSIONS=2
```

## Maintenance

### Daily Backups

Automatic daily backups to `S:\rg_data\backups\`. 7-day retention.

Manual backup:
```powershell
docker exec rg-postgres pg_dump -U rg_admin rg_consulting > backup.sql
```

### Update Containers

```powershell
docker compose -f docker-compose.phase1.yml pull
docker compose -f docker-compose.phase1.yml up -d
```

### View Resource Usage

```powershell
docker stats --no-stream
```

## Integration with Cloudflare

The local infrastructure syncs with Cloudflare Workers/D1:

1. **Webhooks**: Cloudflare Workers POST to `http://homelab/webhook/*`
2. **Job Results**: Browser service POSTs results back to Cloudflare
3. **Data Sync**: API syncs clients/projects to/from D1

Configure `CLOUDFLARE_SYNC_ENABLED=true` in `.env` to enable.

## Security Notes

1. **nginx** restricts n8n UI and browser API to local/Tailscale IPs
2. **API keys** should be set for production use
3. **Passwords** are auto-generated on first run
4. **No external ports** exposed without nginx proxy

## Next Steps

After Phase 1 is running:

1. Configure n8n credentials (HubSpot, Trello, etc.)
2. Import workflow templates
3. Set up Cloudflare Tunnel for external webhooks
4. Proceed to Phase 2: Toast ABO Engine
